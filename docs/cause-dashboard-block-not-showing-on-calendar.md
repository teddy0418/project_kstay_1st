# 원인 분석: 이번 주 예약 현황에서 판매 중지 눌러도 캘린더에 안 나오는 현상

## 현상
- 대시보드 **이번 주 예약 현황**에서 **판매 중지**를 누르면 해당 날짜가 빨간색(판매 중지)으로 잘 표시됨.
- 같은 숙소로 **캘린더**를 열면, 방금 막은 날짜가 **판매 중지로 표시되지 않음** (열려 있는 것처럼 보임).

---

## 원인 (결론)

### 1. **브라우저/클라이언트 캐시 (주요 원인)**
- 캘린더는 **차단일 목록**을 `GET /api/host/listings/[id]/blocked-dates?from=...&to=...` 로 가져옴.
- 이 GET 요청에 **캐시 제어**가 없으면:
  - 브라우저가 같은 URL의 이전 응답을 **캐시**해 둘 수 있음.
  - 대시보드에서 판매 중지(POST)로 DB는 갱신되었지만, 캘린더로 이동했을 때 **이전에 캐시된 “차단일 없음” 응답**이 쓰일 수 있음.
- 그래서 **방금 막은 날짜가 캘린더에는 반영되지 않은 것처럼** 보임.

### 2. **숙소(listingId) 불일치 가능성**
- 대시보드에서는 **선택한 숙소**에만 판매 중지를 적용함 (`?listingId=xxx`).
- 캘린더를 **메뉴/사이드바**로만 열면 `?listingId` 없이 진입 → 캘린더는 **목록의 첫 번째 숙소**를 보여줌.
- 이때 **대시보드에서 막은 숙소 ≠ 캘린더에 보이는 숙소**이면, 당연히 캘린더에는 판매 중지가 안 보임.
- **같은 숙소**를 보려면: 대시보드에서 **「캘린더에서 보기」** 링크로 이동하거나, 캘린더에서 숙소를 같은 것으로 선택해야 함.

### 3. **응답 구조 오타/불일치**
- API는 `{ data: { dates: ["2025-03-01", ...] } }` 형태로 반환.
- 클라이언트는 `d.data?.dates ?? []` 로 사용. 구조는 맞지만, `dates`가 없거나 배열이 아닐 때 `[]`로 안전하게 넣어 두었는지 확인하는 것이 좋음 → `Array.isArray(d?.data?.dates) ? d.data.dates : []` 로 강화함.

---

## 적용한 수정 사항

1. **GET 차단일 API**
   - 응답 헤더에 **`Cache-Control: no-store, no-cache, must-revalidate`** 추가.
   - 같은 URL이라도 **캐시하지 않고 항상 최신 차단일**을 받도록 함.
   - 라우트에 **`export const dynamic = "force-dynamic"`** 추가해, 서버 쪽에서도 정적 캐시되지 않도록 함.

2. **캘린더 쪽 fetch**
   - `fetch(..., { cache: "no-store" })` 로 호출해, **클라이언트에서도 캐시를 쓰지 않도록** 함.
   - `setBlockedDates(Array.isArray(d?.data?.dates) ? d.data.dates : [])` 로 응답이 깨져도 빈 배열로 안전하게 처리.

---

## 사용 시 확인할 점

- 대시보드에서 **특정 숙소**를 선택한 뒤 판매 중지했다면, 캘린더에서도 **같은 숙소**가 선택된 상태인지 확인.
- **「캘린더에서 보기」** 링크를 쓰면 같은 숙소로 이동하므로, 판매 중지가 바로 반영된 것을 확인하기 좋음.

위 수정으로 **캐시**와 **응답 처리**를 막아 두었으므로, 판매 중지 후 캘린더로 이동하면 해당 날짜가 판매 중지로 표시되어야 함.
