generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  GUEST
  HOST
  ADMIN
}

enum ListingStatus {
  DRAFT    // 호스트 초안 저장(autosave)
  PENDING  // 검토 요청됨
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  CANCELLED
}

enum PaymentProvider {
  MOCK
  PORTONE
}

enum PaymentStatus {
  INITIATED
  PAID
  FAILED
  CANCELLED
}

model User {
  id              String   @id @default(cuid())
  role            Role     @default(GUEST)
  email           String?  @unique
  name            String   @default("Guest")
  image           String?
  displayName     String?  // 프로필 설정에서 설정한 표시 이름 (리뷰 등에 사용)
  profilePhotoUrl String?  @db.Text // 프로필 설정에서 설정한 사진 URL (리뷰 아바타 등)
  locale          String   @default("en-US")
  currency        String   @default("USD")
  phone           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  hostProfile HostProfile?
  listings    Listing[]      @relation("HostListings")
  bookings    Booking[]      @relation("GuestBookings")
  wishlist    WishlistItem[]
  reviews     Review[]
}

model HostProfile {
  userId    String  @id
  displayName String?
  payoutBank  String?
  payoutAccount String?
  payoutName  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Listing {
  id        String        @id @default(cuid())
  hostId    String
  status    ListingStatus @default(PENDING)
  approvedAt DateTime?

  title     String   // default (en)
  titleKo   String?
  titleJa   String?
  titleZh   String?
  city      String
  area      String
  address   String
  location  String?
  lat       Float?
  lng       Float?

  basePriceKrw Int
  rating    Float   @default(4.9)
  reviewCount Int  @default(0)
  hostBio   String?
  hostBioKo String?
  hostBioJa String?
  hostBioZh String?
  checkInTime  String  @default("15:00")
  checkOutTime String?
  checkInGuideMessage String?  @db.Text // 체크인 안내 (게스트에게 전달)
  houseRulesMessage   String?  @db.Text // 이용 규칙·안내 메시지
  amenities    String[] @default([])
  maxGuests    Int?     // 검색/필터용
  bedrooms     Int?
  beds         Int?
  bathrooms    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  host   User          @relation("HostListings", fields: [hostId], references: [id], onDelete: Restrict)
  images ListingImage[]
  bookings Booking[]
  wishlist WishlistItem[]
  reviews Review[]
  blockedDates   ListingBlockedDate[]
  datePrices     ListingDatePrice[]

  @@index([status, createdAt])
  @@index([hostId, createdAt])
  @@index([hostId, status, createdAt])
}

/// 호스트가 특정 날짜를 판매 중지(Block)한 경우
model ListingBlockedDate {
  id        String   @id @default(cuid())
  listingId String
  date      DateTime @db.Date

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
}

/// 날짜별 요금 오버라이드 (유동 가격). 없으면 basePriceKrw 사용
model ListingDatePrice {
  id        String   @id @default(cuid())
  listingId String
  date      DateTime @db.Date
  priceKrw  Int

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
}

model ListingImage {
  id        String @id @default(cuid())
  listingId String
  url       String
  sortOrder Int    @default(0)

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

model Booking {
  id            String        @id @default(cuid())
  publicToken   String        @unique
  listingId     String
  guestUserId   String?
  guestEmail    String
  guestName     String?

  checkIn       DateTime
  checkOut      DateTime
  nights        Int

  guestsAdults  Int @default(1)
  guestsChildren Int @default(0)
  guestsInfants Int @default(0)
  guestsPets    Int @default(0)

  currency      String @default("USD")
  totalUsd      Int
  totalKrw      Int
  accommodationKrw Int?     // 숙박료 (게스트 결제 내역·호스트 수령액 산출용)
  guestServiceFeeKrw Int?   // 게스트 서비스 수수료 12%

  status        BookingStatus @default(PENDING_PAYMENT)
  confirmedAt   DateTime?
  cancellationDeadlineKst DateTime
  confirmationEmailSentAt DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  listing       Listing @relation(fields: [listingId], references: [id], onDelete: Restrict)
  guestUser     User?   @relation("GuestBookings", fields: [guestUserId], references: [id], onDelete: SetNull)
  payments      Payment[]
  review        Review?

  @@index([listingId])
  @@index([guestUserId])
  @@index([publicToken])
  @@index([status, createdAt])
  @@index([listingId, status])
  @@index([guestUserId, status])
  @@index([listingId, status, checkIn, checkOut])
}

model Review {
  id         String   @id @default(cuid())
  bookingId String   @unique
  userId     String
  listingId  String
  rating     Int      // 1..5 overall (평균 또는 기존 단일 별점)
  body       String   @db.Text
  // 6개 카테고리 별점 (1..5). 있으면 상세 페이지에서 평균 표시
  cleanliness   Int?
  accuracy      Int?
  checkIn       Int?
  communication Int?
  location      Int?
  value         Int?
  createdAt  DateTime @default(now())

  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing  Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([userId])
}

model Payment {
  id         String          @id @default(cuid())
  bookingId  String
  provider   PaymentProvider @default(MOCK)
  status     PaymentStatus   @default(INITIATED)
  amountUsd  Int
  amountKrw  Int?            // KRW 결제 시 기대 금액 (웹훅 금액 검증용)
  providerPaymentId String?
  storeId    String?
  pgTid      String?
  rawJson    String?
  createdAt  DateTime @default(now())
  paidAt     DateTime?

  booking    Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([bookingId, createdAt])
  @@index([providerPaymentId])
}

model PaymentWebhookEvent {
  id               String   @id @default(cuid())
  provider         String
  webhookId        String
  webhookTimestamp String
  webhookSignature String
  payloadRaw       String
  parsedType       String?
  paymentId        String?
  receivedAt       DateTime @default(now())

  @@unique([provider, webhookId])
  @@index([paymentId])
}

model WishlistItem {
  userId    String
  listingId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@id([userId, listingId])
  @@index([listingId])
  @@index([userId, createdAt])
}
