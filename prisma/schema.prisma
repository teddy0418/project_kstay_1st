generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  GUEST
  HOST
  ADMIN
}

enum ListingStatus {
  DRAFT    // 호스트 초안 저장(autosave)
  PENDING  // 검토 요청됨
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING_PAYMENT
  CONFIRMED
  CANCELLED
}

enum PaymentProvider {
  MOCK
  PORTONE
}

enum PaymentStatus {
  INITIATED
  PAID
  FAILED
  CANCELLED
}

model User {
  id              String   @id @default(cuid())
  role            Role     @default(GUEST)
  email           String?  @unique
  name            String   @default("Guest")
  image           String?
  displayName     String?  // 프로필 설정에서 설정한 표시 이름 (리뷰 등에 사용)
  profilePhotoUrl String?  @db.Text // 프로필 설정에서 설정한 사진 URL (리뷰 아바타 등)
  locale          String   @default("en-US")
  currency        String   @default("USD")
  phone           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  hostProfile HostProfile?
  listings    Listing[]      @relation("HostListings")
  bookings    Booking[]      @relation("GuestBookings")
  wishlist    WishlistItem[]
  reviews     Review[]
}

model HostProfile {
  userId    String  @id
  displayName String?
  payoutBank  String?
  payoutAccount String?
  payoutName  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Listing {
  id        String        @id @default(cuid())
  hostId    String
  status    ListingStatus @default(PENDING)
  approvedAt DateTime?

  title     String   // default (en)
  titleKo   String?
  titleJa   String?
  titleZh   String?
  city      String
  area      String
  address   String
  location  String?
  lat       Float?
  lng       Float?
  // 구조화 주소 (한국: 시/도, 시/군/구, 도로명, 상세, 우편)
  country       String?  @default("KR")
  stateProvince String?  // 시/도 (Seoul, Busan, Gyeonggi-do 등)
  cityDistrict  String?  // 시/군/구 (Mapo-gu, Jongno-gu 등)
  roadAddress   String?  // 도로명 주소
  detailedAddress String? @db.Text // 상세 주소 (예약 확정 전까지 비공개)
  zipCode       String?  // 우편번호

  basePriceKrw Int
  extraGuestFeeKrw Int?  @default(0)  // 인원 추가당 요금 (기본 인원 초과 시 1인당)
  rating    Float   @default(4.9)
  reviewCount Int  @default(0)
  hostBio   String?
  hostBioKo String?
  hostBioJa String?
  hostBioZh String?
  checkInTime  String  @default("15:00")
  checkOutTime String?
  checkInGuideMessage String?  @db.Text // 체크인 안내 (게스트에게 전달)
  houseRulesMessage   String?  @db.Text // 이용 규칙·안내 메시지
  amenities    String[] @default([])
  propertyType String?  // 숙소 유형: apartment, house, secondary, hotel_room, other
  maxGuests    Int?     // 최대 숙박 인원
  bedrooms     Int?
  beds         Int?
  bathrooms    Float?

  // 가격·환불 설정
  weekendSurchargePct    Int?     @default(0)  // 주말(금·토) 할증 %
  peakSurchargePct       Int?     @default(0)  // 성수기 할증 % (KSTAY 표준 달력 추후 적용)
  nonRefundableSpecialEnabled Boolean @default(false)  // 환불 불가 특가 옵션 (10% 할인)
  freeCancellationDays   Int?     @default(5)  // 표준: 체크인 N일 전 23:59 KST까지 무료 취소

  // 검토 시 제출 서류 (URL: 업로드 후 저장된 이미지 URL)
  businessRegistrationDocUrl String?  @db.Text // 사업자등록증
  lodgingReportDocUrl        String?  @db.Text // 민박업 신고증 또는 외국어관광도시민박업 지정증

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  host   User          @relation("HostListings", fields: [hostId], references: [id], onDelete: Restrict)
  images ListingImage[]
  bookings Booking[]
  wishlist WishlistItem[]
  reviews Review[]
  blockedDates   ListingBlockedDate[]
  datePrices     ListingDatePrice[]

  @@index([status, createdAt])
  @@index([hostId, createdAt])
  @@index([hostId, status, createdAt])
}

/// 호스트가 특정 날짜를 판매 중지(Block)한 경우
model ListingBlockedDate {
  id        String   @id @default(cuid())
  listingId String
  date      DateTime @db.Date

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
}

/// 날짜별 요금 오버라이드 (유동 가격). 없으면 basePriceKrw 사용
model ListingDatePrice {
  id        String   @id @default(cuid())
  listingId String
  date      DateTime @db.Date
  priceKrw  Int

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
}

model ListingImage {
  id        String @id @default(cuid())
  listingId String
  url       String
  sortOrder Int    @default(0)

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
}

model Booking {
  id            String        @id @default(cuid())
  publicToken   String        @unique
  listingId     String
  guestUserId   String?
  guestEmail    String
  guestName     String?

  checkIn       DateTime
  checkOut      DateTime
  nights        Int

  guestsAdults  Int @default(1)
  guestsChildren Int @default(0)
  guestsInfants Int @default(0)
  guestsPets    Int @default(0)

  currency      String @default("USD")
  totalUsd      Int
  totalKrw      Int
  accommodationKrw Int?     // 숙박료 (게스트 결제 내역·호스트 수령액 산출용)
  guestServiceFeeKrw Int?   // 게스트 서비스 수수료 12%

  status        BookingStatus @default(PENDING_PAYMENT)
  confirmedAt   DateTime?
  cancellationDeadlineKst DateTime   // 무료 취소 마감 시각 (레거시·표시용, KST 기준 해석)
  confirmationEmailSentAt DateTime?

  // 취소 정책 스냅샷 (분쟁·차지백 대비)
  isNonRefundableSpecial   Boolean   @default(false)  // 환불 불가 특가 예약 여부
  cancellationPolicyVersion String?  // 예: v1-standard-5d
  policyTextLocale         String?   // ko, en 등
  policyType               String?   // STANDARD | NON_REFUNDABLE
  freeCancelEndsAt         DateTime? // 무료 취소 마감 시각 (canonical)
  refundSchedule           String?   @db.Text // JSON: 당시 환불 규정 설명
  policyAgreedAt           DateTime? // 게스트가 정책 동의 체크한 시각

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  listing       Listing @relation(fields: [listingId], references: [id], onDelete: Restrict)
  guestUser     User?   @relation("GuestBookings", fields: [guestUserId], references: [id], onDelete: SetNull)
  payments      Payment[]
  review        Review?

  @@index([listingId])
  @@index([guestUserId])
  @@index([publicToken])
  @@index([status, createdAt])
  @@index([listingId, status])
  @@index([guestUserId, status])
  @@index([listingId, status, checkIn, checkOut])
}

model Review {
  id         String   @id @default(cuid())
  bookingId String   @unique
  userId     String
  listingId  String
  rating     Int      // 1..5 overall (평균 또는 기존 단일 별점)
  body       String   @db.Text
  // 6개 카테고리 별점 (1..5). 있으면 상세 페이지에서 평균 표시
  cleanliness   Int?
  accuracy      Int?
  checkIn       Int?
  communication Int?
  location      Int?
  value         Int?
  createdAt  DateTime @default(now())

  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing  Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([userId])
}

model Payment {
  id         String          @id @default(cuid())
  bookingId  String
  provider   PaymentProvider @default(MOCK)
  status     PaymentStatus   @default(INITIATED)
  amountUsd  Int
  amountKrw  Int?            // KRW 결제 시 기대 금액 (웹훅 금액 검증용)
  providerPaymentId String?
  storeId    String?
  pgTid      String?
  rawJson    String?
  createdAt  DateTime @default(now())
  paidAt     DateTime?

  booking    Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([bookingId, createdAt])
  @@index([providerPaymentId])
}

model PaymentWebhookEvent {
  id               String   @id @default(cuid())
  provider         String
  webhookId        String
  webhookTimestamp String
  webhookSignature String
  payloadRaw       String
  parsedType       String?
  paymentId        String?
  receivedAt       DateTime @default(now())

  @@unique([provider, webhookId])
  @@index([paymentId])
}

model WishlistItem {
  userId    String
  listingId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@id([userId, listingId])
  @@index([listingId])
  @@index([userId, createdAt])
}
